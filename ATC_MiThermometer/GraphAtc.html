<!DOCTYPE html>
<html>
  <head><meta charset="utf-8">
  <link rel="stylesheet" href="styles.css">
<style type="text/css">
/**
 * Default styles for the dygraphs charting library.
 */

.dygraph-legend {
  position: relative;
  font-size: 12px;
  z-index: 10;
  width: 250px;  /* labelsDivWidth */
  /*
  dygraphs determines these based on the presence of chart labels.
  It might make more sense to create a wrapper div around the chart proper.
  top: 0px;
  right: 2px;
  */
  background: white;
  line-height: normal;
  text-align: center;
  overflow: hidden;
}

/* styles for a solid line in the legend */
.dygraph-legend-line {
  display: inline-block;
  position: relative;
  bottom: .5ex;
  padding-left: 1em;
  height: 1px;
  border-bottom-width: 2px;
  border-bottom-style: solid;
  /* border-bottom-color is set based on the series color */
}

/* styles for a dashed line in the legend, e.g. when strokePattern is set */
.dygraph-legend-dash {
  display: inline-block;
  position: relative;
  bottom: .5ex;
  height: 1px;
  border-bottom-width: 2px;
  border-bottom-style: solid;
  /* border-bottom-color is set based on the series color */
  /* margin-right is set based on the stroke pattern */
  /* padding-left is set based on the stroke pattern */
}

.dygraph-roller {
  position: absolute;
  z-index: 10;
}

/* This class is shared by all annotations, including those with icons */
.dygraph-annotation {
  position: absolute;
  z-index: 10;
  overflow: hidden;
}

/* This class only applies to annotations without icons */
/* Old class name: .dygraphDefaultAnnotation */
.dygraph-default-annotation {
  border: 1px solid black;
  background-color: white;
  text-align: center;
}

.dygraph-axis-label {
  /* position: absolute; */
  /* font-size: 14px; */
  z-index: 10;
  line-height: normal;
  overflow: hidden;
  color: black;  /* replaces old axisLabelColor option */
}

.dygraph-axis-label-x {
}

.dygraph-axis-label-y {
  color: green; 
}

.dygraph-axis-label-y2 {
  color: blue; 
}

.dygraph-title {
  font-weight: bold;
  z-index: 10;
  text-align: center;
  /* font-size: based on titleHeight option */
}

.dygraph-xlabel {
  text-align: center;
  /* font-size: based on xLabelHeight option */
}

/* For y-axis label */
.dygraph-label-rotate-left {
  text-align: center;
  /* See http://caniuse.com/#feat=transforms2d */
  transform: rotate(90deg);
  -webkit-transform: rotate(90deg);
  -moz-transform: rotate(90deg);
  -o-transform: rotate(90deg);
  -ms-transform: rotate(90deg);
}

/* For y2-axis label */
.dygraph-label-rotate-right {
  text-align: center;
  /* See http://caniuse.com/#feat=transforms2d */
  transform: rotate(-90deg);
  -webkit-transform: rotate(-90deg);
  -moz-transform: rotate(-90deg);
  -o-transform: rotate(-90deg);
  -ms-transform: rotate(-90deg);
}
</style>
  <title>ATC Temperature and Humidity</title>
  <script src="dygraph.min.js"></script>
  </head>
  <body>
	<h1>ATC Temperature and Humidity</h1>
	<div class="navbar">
        <div class="container nav-container">
            <input class="checkbox" type="checkbox" name="" id="">
            <div class="hamburger-lines">
              <span class="line line1"></span>
              <span class="line line2"></span>
              <span class="line line3"></span>
            </div>  
          <div class="menu-items">
				<li> GitHub </li>
				<li><a href="https://github.com/pvvx/ATC_MiThermometer">&#9432;pvvx</a></li>
				<li> Live Data </li>
				<li><a href="GraphAtc.html">Graph Atc 1</a></li>
				<li><a href="GraphAtc1.html">Graph Atc 2</a></li>
				<li><a href="GraphAtc2.html">Graph Atc 3</a></li>
				<li><a href="DevPoint.html">Dev Point</a></li>
				<li><a href="Advertising.html">Advertising</a></li>
				<li>Stored data</li>
				<li><a href="GraphMemo.html">Memo Graph</a></li>
				<li><a href="GraphMemoOriginal.html">LYWSD03MMC Memo Graph </a></li>
				<li>Others & Flasher</li>
				<li><a href="TelinkMiFlasher.html">Flasher</a></li>
				<li><a href="TelinkOTA.html">OTA Flasher</a></li>
          </div>
        </div>
    </div>
	<hr>
	<div style="height: auto; width: auto; text-align: center;">
		<input type="button" id="butConnect" value="Connect" class="ok">
		<input type="button" id="butOnOff" value="Stop" disabled="true">
		<input type="button" id="butClr" value="Clear" disabled="true">
		<input type="button" id="butSave" value="Save data to .csv file" disabled="true">
		<br><br>
		<input type="radio" checked name='rm1'  id="FixEnd"/>
		<label for="FixEnd">Fixed</label>
		<input type="radio" name='rm1' id="FixNone"/>
		<label for="FixNone">Float</label>
		<div id="div_v"></div>
		<div id='labdiv'></div>
	</div>
  </body>
<script type="text/javascript">
var $ = function(id) {
	return document.getElementById(id);
}
var temp;
var humi;
var cur_idx = 0;
var samples = 20000;

// Вывод в терминал
function log(data) {console.log(data);}
var devcnn = 0;
var stg = 0;
var rend = 1;
$("butOnOff").onclick =  function() {
	if(rend) {rend = 0; $("butOnOff").value = "Run";}
	else {rend = 1; $("butOnOff").value = "Stop";}
}
function ShowConnect() {
	if(devcnn==0)  {
		$("butConnect").value = "Connect";
		$("butConnect").classList.remove("danger");
		$("butClr").disabled = true;
		$("butOnOff").disabled = true;
		$("butSave").disabled = true;} 
	else {
		$("butConnect").value = "Disconnect " +  deviceCache?.name; 
		$("butConnect").classList.add("danger");
		$("butClr").disabled = false;
		$("butOnOff").disabled = false;
		$("butSave").disabled = false;} 
	$("butConnect").disabled = false;
}
$("butConnect").onclick =  function() {
	$("butConnect").disabled = true;
	if(devcnn != 0) {$("butConnect").value = "Disconnect..."; disconnect();}
	else {$("butConnect").value = "Connect..."; connect();};
}
// Буфер входящих данных
var datau = [];
var gu;
$("butClr").onclick =  function() {
	datau = new Array();
	stg = 0;
	cur_idx = 0;
	gu.destroy();
}
function ShowGrf() {
	if(rend) {
		datau.push([new Date(), temp, humi]);
		cur_idx++;
		if(cur_idx >= samples) datau.shift();
	}
	if(!stg) {
		gu = new Dygraph(
			$("div_v"),
		    datau,
			{
				title: "Live data for: " + deviceCache?.name,
				showRangeSelector: true,
				showRoller: true,
				rollPeriod: 7,
				xlabel: 'Time(sec)',
				ylabel: 'Temp(C&deg;)',
				y2label: 'H(%)',
				colors: ['green', 'blue'],
				series : { 'H(%)': { axis: 'y2' } },
				labels: ['T(sec)', 'T(°C)', 'H(%)'],
				labelsDiv: $('labdiv'),
				legend: 'always',  // "follow"
				digitsAfterDecimal: 3,
			});
		setInterval(function(){renderChart()}, 500);
		stg = 1;
	}
}
var renderChart = function() {
	let dl;
	if (gu.dateWindow_) {
		dl = gu.dateWindow_[1] - gu.dateWindow_[0];
	    if ($("FixEnd").checked) {
			var ls = datau.length - 1;
			gu.dateWindow_[1] = datau[ls][0];
			gu.dateWindow_[0] = datau[ls][0] - dl;
		} else if (gu.dateWindow_[0] < datau[0][0]) {
			gu.dateWindow_[0] = datau[0][0];
			gu.dateWindow_[1] = datau[0][0] + dl;
	   	}
	} 
	if(rend && datau.length != 0) gu.updateOptions({'file': datau});
}
function convertArrayOfObjectsToCSV(value){
	var result, ctr, keys, columnDelimiter, lineDelimiter, data;
	data = value.data || null;
	if (data == null || !data.length) {return null;}
	columnDelimiter = value.columnDelimiter || ';';
	lineDelimiter = value.lineDelimiter || '\n';
	keys = Object.keys(data[1]);
	result = '';
	data.forEach(function(item){
		ctr = 0;
		keys.forEach(function(key){
			if (ctr > 0) {
				result += columnDelimiter;
				result += item[key];
			} else 
				result += item[key].getTime();
			ctr++;
		});
		result += lineDelimiter;
	});
	return result;
}
function download(data, filename, type) {
	var file = new Blob([data], {type: type});
	if (window.navigator.msSaveOrOpenBlob) { // ie10+
		window.navigator.msSaveOrOpenBlob(file, filename);
	} else { // ff, chrome
		url = URL.createObjectURL(file);
		var a = document.createElement("a");
		a.href = url;
		a.download = filename;
		document.body.appendChild(a);
		a.click();
		setTimeout(function(){document.body.removeChild(a);window.URL.revokeObjectURL(url);},0);
		URL.revokeObjectURL(url);
	}
}
$("butSave").onclick =  function() {
    download(convertArrayOfObjectsToCSV({data: datau}), 'data.csv', 'text/csv;charset=utf-8');
}
if(window.innerHeight > 400) $('div_v').style.height = (window.innerHeight-220) + 'px';
window.onresize = function(){
	if(window.innerHeight > 400) $('div_v').style.height = (window.innerHeight-220) + 'px';
//	$('div_v').style.width = (window.innerWidth-50) + 'px';
}
var pack_samples = 8;
function hex(number, length) {
    var str = (number.toString(16)).toUpperCase();
    while (str.length < length) str = '0' + str;
    return str;
} 
function WaitConnection() {
	if(devcnn && !stg) {
		disconnect(); 
		alert('Device not Start!');
	}
}
function ResponsePkt(head, value) {
	let ds = value.byteLength;
	let s = 'msg: ';
    for(let i=0; i < ds; i++) {
		s+=' '+hex(value.getUint8(i),2);
		if(i<ds-1) s+=',';
	}
	log(s);
}	
//--BLE---------------------------------------
// Кэш объекта выбранного устройства
let deviceCache = null;
// Кэш объекта характеристики
var characteristicTemp = null;
var characteristicHumi = null;
// Запустить выбор Bluetooth устройства и подключиться к выбранному
function connect() {
	return (deviceCache ? Promise.resolve(deviceCache) :
		requestBluetoothDevice()).
			then(device => connectDeviceAndCacheCharacteristic(device)).
		catch(error => { log(error); ShowConnect();});
}
// Запрос выбора Bluetooth устройства
function requestBluetoothDevice() {
	var deviceOptions = {optionalServices: [0x181a]};
	deviceOptions.filters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ abcdefghijklmnopqrstuvwxyz_#@!*';,.<>{}[]"
	.split("").map((x) => ({namePrefix:x}));
	// deviceOptions.filters.services = [0xfe95, 0x181a, 0x1f10];
	log('Requesting bluetooth device...');
	return navigator.bluetooth.requestDevice(deviceOptions).
	then(device => {
		log('"' + device.name + '" bluetooth device selected');
		deviceCache = device;
		deviceCache.addEventListener('gattserverdisconnected', handleDisconnection);
		return deviceCache;
	});
}
// Обработчик разъединения
function handleDisconnection(event) {
	let device = event.target;
    ShowConnect();
	if(devcnn != 0) {
		log('"' + device.name + '" bluetooth device disconnected, trying to reconnect...');
		connectDeviceAndCacheCharacteristic(device).
			then(characteristic => {
				devcnn = 1;
		        ShowConnect()
        		stage_read = 0;
				setTimeout(WaitConnection, 20000);
			}).
			catch(error => log(error));
	}
}
// Подключение к определенному устройству, получение сервиса и характеристики
function connectDeviceAndCacheCharacteristic(device) {
  if (device.gatt.connected && characteristicTemp && characteristicHumi) { // 
	return Promise.resolve(null);
  }
  log('Connecting to GATT server...');
  return device.gatt.connect().
	then(server => {
		log('GATT server connected, getting service...');
		return server.getPrimaryService(0x181A); // (0x180F);
	}).
	then(service => {
		log('Service found, getting Humidity characteristic...');
		service.getCharacteristic(0x2A6F).
		  then(characteristic => {
			log('Characteristic Humi found');
			characteristicHumi = characteristic;
			return characteristicHumi.startNotifications().
			then(() => {
				characteristicHumi.addEventListener('characteristicvaluechanged', event => {
					var value = event.target.value;
					humi = value.getInt16(0, true) / 100.0;
					log('Humi: '+humi+ '%');
					ShowGrf();
				});
	  	  	});
  		});
		log('Getting Temp characteristic...');
		return service.getCharacteristic(0x2A1F); // (0x2A19)
	}).
	then(characteristic => {
		log('Characteristic Temp found');
		characteristicTemp = characteristic;
		devcnn = 1;
		ShowConnect();
		return characteristicTemp.startNotifications().
		then(() => {
			characteristicTemp.addEventListener('characteristicvaluechanged', event => {
				var value = event.target.value;
				temp = value.getInt16(0, true) / 10.0;
				log('Temp: '+temp+ '°C');
			});
	  	});
	});
}
// Отключиться от подключенного устройства
function disconnect() {
	devcnn = 0;

	if (deviceCache) {
		log('Disconnecting from "' + deviceCache.name + '" bluetooth device...');
		deviceCache.removeEventListener('gattserverdisconnected', handleDisconnection);
		if (deviceCache.gatt.connected) {
			if (characteristicTemp) {
				characteristicTemp.stopNotifications()
				.then(_ => {
					log('Notifications Temp stopped');
				})
				.catch(error => { log(error);
					if (characteristicHumi) {
						characteristicHumi.removeEventListener('characteristicvaluechanged', handleCharacteristicValueChanged);
						characteristicHumi = null;
					}
					deviceCache = null;
					ShowConnect();
				});
			};
			if (characteristicHumi) {
				characteristicHumi.stopNotifications()
				.then(_ => {
					log('Notifications Humi stopped');
				  	if (deviceCache.gatt.connected) {
						deviceCache.gatt.disconnect();
						log('"' + deviceCache.name + '" bluetooth device disconnected');
					}
					deviceCache = null;
					ShowConnect();
				})
				.catch(error => { log(error); 
					if (characteristicHumi) {
						characteristicHumi.removeEventListener('characteristicvaluechanged', handleCharacteristicValueChanged);
						characteristicHumi = null;
					}
					deviceCache = null;
					ShowConnect();
				});
			}
		}
	}
	else
		log('"' + deviceCache.name + '" bluetooth device is already disconnected');
}
</script>
</html>